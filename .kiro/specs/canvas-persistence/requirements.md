# 需求文档

## 简介

本文档定义了「持久化画布」功能的需求规格。该功能允许用户在画布上查看当前项目的所有历史生成图片，并在重新进入项目时恢复上次的工作状态（包括图片位置、视口位置和缩放比例）。系统采用智能加载策略，确保在大量图片场景下仍能保持流畅的用户体验。

## 术语表

- **Canvas（画布）**：用户进行图片生成和查看的主要工作区域
- **Viewport（视口）**：当前屏幕可见的画布区域
- **Canvas_State（画布状态）**：包含视口位置、缩放比例等信息的 JSON 对象
- **Thumbnail（缩略图）**：图片的低分辨率版本，用于快速加载和预览
- **Progressive_Loading（渐进式加载）**：先加载缩略图，再按需加载高清图的策略
- **Virtual_Rendering（虚拟渲染）**：只渲染视口内可见元素的优化技术

## 需求

### 需求 1

**用户故事：** 作为用户，我希望进入项目时能看到该项目的所有历史生成图片，以便我能回顾之前的创作并决定下一步生成什么。

#### 验收标准

1. WHEN 用户进入一个项目 THEN Canvas 组件 SHALL 从数据库加载该项目的所有图片记录
2. WHEN 图片数据加载完成 THEN Canvas 组件 SHALL 在画布上按保存的位置显示所有图片
3. WHEN 项目中没有图片 THEN Canvas 组件 SHALL 显示空状态提示引导用户开始创作
4. WHEN 用户切换到另一个项目 THEN Canvas 组件 SHALL 清空当前画布并加载新项目的图片

### 需求 2

**用户故事：** 作为用户，我希望系统能记住每张图片在画布上的位置，以便我下次进入时能看到相同的布局。

#### 验收标准

1. WHEN 用户在画布上拖拽移动图片 THEN Canvas 组件 SHALL 将新位置保存到数据库
2. WHEN 新图片生成完成 THEN Canvas 组件 SHALL 自动计算不重叠的位置并保存到数据库
3. WHEN 用户重新进入项目 THEN Canvas 组件 SHALL 按数据库中保存的位置恢复图片布局
4. WHEN 位置保存失败 THEN Canvas 组件 SHALL 在本地缓存位置信息并在网络恢复后重试

### 需求 3

**用户故事：** 作为用户，我希望系统能记住我上次查看画布的位置和缩放比例，以便我能快速回到上次工作的地方。

#### 验收标准

1. WHEN 用户离开项目页面 THEN Canvas 组件 SHALL 保存当前视口位置和缩放比例到数据库
2. WHEN 用户重新进入项目 THEN Canvas 组件 SHALL 恢复上次保存的视口位置和缩放比例
3. WHEN 项目没有保存的视口状态 THEN Canvas 组件 SHALL 自动定位到最新生成的图片位置
4. WHEN 用户点击重置视图按钮 THEN Canvas 组件 SHALL 将视口重置为默认位置和 100% 缩放

### 需求 4

**用户故事：** 作为用户，我希望在有大量图片时画布仍能流畅运行，以便我能高效地浏览和管理我的创作。

#### 验收标准

1. WHEN 画布上有超过 50 张图片 THEN Canvas 组件 SHALL 只渲染视口内可见的图片 DOM 元素
2. WHEN 图片位于视口外 THEN Canvas 组件 SHALL 显示轻量级占位符而非完整图片元素
3. WHEN 用户快速滚动或拖拽画布 THEN Canvas 组件 SHALL 保持至少 30fps 的渲染帧率
4. WHEN 内存使用超过阈值 THEN Canvas 组件 SHALL 卸载长时间不可见的高清图片数据

### 需求 5

**用户故事：** 作为用户，我希望图片能智能加载，先显示模糊预览再变清晰，以便我能快速浏览大量图片。

#### 验收标准

1. WHEN 图片首次进入视口 THEN Canvas 组件 SHALL 先显示缩略图或模糊占位符
2. WHEN 图片在视口内停留超过 300 毫秒 THEN Canvas 组件 SHALL 开始加载高清图片
3. WHEN 高清图片加载完成 THEN Canvas 组件 SHALL 使用淡入动画替换缩略图
4. WHEN 图片离开视口 THEN Canvas 组件 SHALL 保留已加载的高清图片不进行降级
5. WHEN 用户双击图片查看详情 THEN Canvas 组件 SHALL 立即加载高清图片不等待延迟

### 需求 6

**用户故事：** 作为用户，我希望新生成的图片能自动添加到画布上合适的位置，以便我能持续创作而不需要手动整理。

#### 验收标准

1. WHEN 新图片生成完成 THEN Canvas 组件 SHALL 在画布上找到不与现有图片重叠的位置
2. WHEN 新图片添加到画布 THEN Canvas 组件 SHALL 自动将视口平滑滚动到新图片位置
3. WHEN 新图片位置确定 THEN Canvas 组件 SHALL 立即将位置信息保存到数据库
4. IF 画布空间不足 THEN Canvas 组件 SHALL 在现有图片下方或右侧扩展画布区域

### 需求 7

**用户故事：** 作为用户，我希望能快速定位到最新生成的图片，以便我能立即查看生成结果。

#### 验收标准

1. WHEN 用户点击「定位到最新」按钮 THEN Canvas 组件 SHALL 将视口平滑滚动到最新图片位置
2. WHEN 新图片生成完成 THEN Canvas 组件 SHALL 自动定位到新图片位置
3. WHEN 用户手动拖拽画布后 THEN Canvas 组件 SHALL 显示「定位到最新」快捷按钮
4. WHEN 执行定位操作 THEN Canvas 组件 SHALL 使用 300 毫秒的平滑动画过渡

