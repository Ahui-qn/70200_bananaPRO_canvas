# 实现计划

- [x] 1. 数据库结构扩展
  - [x] 1.1 为 images 表添加画布位置字段
    - 添加 `canvas_x` INT 字段存储 X 坐标
    - 添加 `canvas_y` INT 字段存储 Y 坐标
    - 添加 `thumbnail_url` TEXT 字段存储缩略图 URL
    - 更新 `databaseInitializer.ts` 添加迁移逻辑
    - _需求: 2.1, 2.2, 2.3_
  - [x] 1.2 为 projects 表添加画布状态字段
    - 添加 `canvas_state` JSON 字段存储视口状态
    - 更新 `databaseInitializer.ts` 添加迁移逻辑
    - _需求: 3.1, 3.2_

- [x] 2. 后端 API 开发
  - [x] 2.1 扩展 databaseService 支持画布数据
    - 更新 `getImages` 方法返回 canvas_x, canvas_y 字段
    - 更新 `saveImage` 方法支持保存画布位置
    - 添加 `updateImageCanvasPosition` 方法
    - 更新 `rowToSavedImage` 方法映射新字段
    - _需求: 2.1, 2.2, 2.3_
  - [x] 2.2 编写属性测试：图片位置往返一致性
    - **属性 1: 图片位置往返一致性**
    - **验证: 需求 2.3**
  - [x] 2.3 实现画布状态 API
    - 在 `projectService.ts` 添加 `getCanvasState` 方法
    - 在 `projectService.ts` 添加 `saveCanvasState` 方法
    - 在 `projects.ts` 路由添加 GET/PUT `/api/projects/:id/canvas-state` 端点
    - _需求: 3.1, 3.2_
  - [x] 2.4 编写属性测试：视口状态往返一致性
    - **属性 2: 视口状态往返一致性**
    - **验证: 需求 3.2**
  - [x] 2.5 实现项目画布图片批量获取 API
    - 添加 GET `/api/projects/:id/canvas-images` 端点
    - 返回项目所有图片及其画布位置
    - 同时返回项目的画布状态
    - _需求: 1.1, 1.2_

- [x] 3. 检查点 - 确保所有测试通过
  - 确保所有测试通过，如有问题请询问用户。

- [x] 4. 前端类型定义扩展
  - [x] 4.1 更新 shared/types.ts
    - 扩展 `SavedImage` 接口添加 canvasX, canvasY, thumbnailUrl 字段
    - 添加 `CanvasState` 接口定义
    - 添加 `CanvasImage` 接口（包含运行时状态）
    - 添加 `Viewport` 接口定义
    - _需求: 1.1, 2.1, 3.1_

- [x] 5. 前端核心 Hook 开发
  - [x] 5.1 创建 useCanvasImages Hook
    - 创建 `frontend/src/hooks/useCanvasImages.ts`
    - 实现 `loadProjectImages` 方法加载项目图片
    - 实现 `updateImagePosition` 方法（带防抖）
    - 实现 `addNewImage` 方法
    - 实现 `saveCanvasState` 方法
    - _需求: 1.1, 2.1, 3.1_
  - [x] 5.2 编写属性测试：位置保存防抖正确性
    - **属性 7: 位置保存防抖正确性**
    - **验证: 需求 2.1**
  - [x] 5.3 实现位置计算算法
    - 实现 `findNonOverlappingPosition` 函数
    - 使用网格布局算法避免重叠
    - 支持不同尺寸图片的智能排列
    - _需求: 2.2, 6.1_
  - [x] 5.4 编写属性测试：新图片位置不重叠
    - **属性 3: 新图片位置不重叠**
    - **验证: 需求 2.2, 6.1**

- [x] 6. 检查点 - 确保所有测试通过
  - 确保所有测试通过，如有问题请询问用户。

- [x] 7. 虚拟渲染实现
  - [x] 7.1 实现视口可见性计算
    - 创建 `getVisibleImages` 函数
    - 计算图片边界框与视口的相交
    - 添加边距缓冲区提前加载即将可见的图片
    - _需求: 4.1, 4.2_
  - [x] 7.2 编写属性测试：虚拟渲染正确性
    - **属性 4: 虚拟渲染正确性**
    - **验证: 需求 4.1, 4.2**
  - [x] 7.3 实现虚拟渲染组件
    - 创建 `CanvasImageLayer` 组件
    - 只渲染可见图片的完整 DOM
    - 视口外图片使用轻量级占位符
    - _需求: 4.1, 4.2_

- [x] 8. 渐进式加载实现
  - [x] 8.1 创建 ImageLoadingManager
    - 创建 `frontend/src/services/imageLoadingManager.ts`
    - 实现加载优先级队列
    - 实现 300ms 延迟加载逻辑
    - 实现加载状态管理
    - _需求: 5.1, 5.2_
  - [x] 8.2 编写属性测试：渐进式加载状态转换
    - **属性 5: 渐进式加载状态转换**
    - **验证: 需求 5.1, 5.4**
  - [x] 8.3 实现图片组件渐进式加载
    - 修改画布图片渲染逻辑
    - 先显示占位符/缩略图
    - 进入视口后加载高清图
    - 实现淡入过渡动画
    - _需求: 5.1, 5.2, 5.3_

- [x] 9. 检查点 - 确保所有测试通过
  - 确保所有测试通过，如有问题请询问用户。

- [x] 10. CanvasApp 组件集成
  - [x] 10.1 集成 useCanvasImages Hook
    - 在 CanvasApp 中引入 useCanvasImages
    - 替换现有的 canvasImages 状态管理
    - 项目切换时自动加载对应图片
    - _需求: 1.1, 1.4_
  - [x] 10.2 编写属性测试：项目切换数据隔离
    - **属性 6: 项目切换数据隔离**
    - **验证: 需求 1.4**
  - [x] 10.3 集成视口状态持久化
    - 页面卸载时保存视口状态
    - 进入项目时恢复视口状态
    - 实现「定位到最新」按钮
    - _需求: 3.1, 3.2, 7.1, 7.2_
  - [x] 10.4 集成图片位置持久化
    - 拖拽结束时保存位置（带防抖）
    - 新图片生成后自动保存位置
    - 网络失败时本地缓存
    - _需求: 2.1, 2.2, 2.4_
  - [x] 10.5 集成虚拟渲染和渐进式加载
    - 替换现有图片渲染逻辑
    - 使用 CanvasImageLayer 组件
    - 集成 ImageLoadingManager
    - _需求: 4.1, 5.1_

- [x] 11. 检查点 - 确保所有测试通过
  - 确保所有测试通过，如有问题请询问用户。

- [x] 12. 前端 API 服务扩展
  - [x] 12.1 更新 api.ts 添加新接口
    - 添加 `getProjectCanvasImages` 方法
    - 添加 `updateImageCanvasPosition` 方法
    - 添加 `getCanvasState` 方法
    - 添加 `saveCanvasState` 方法
    - _需求: 1.1, 2.1, 3.1_

- [x] 13. UI 优化和交互完善
  - [x] 13.1 添加加载状态指示
    - 项目图片加载时显示进度
    - 单张图片加载时显示占位符动画
    - _需求: 1.1, 5.1_
  - [x] 13.2 添加「定位到最新」按钮
    - 在画布右下角添加快捷按钮
    - 用户拖拽画布后显示按钮
    - 点击后平滑滚动到最新图片
    - _需求: 7.1, 7.3, 7.4_
  - [x] 13.3 添加空状态提示
    - 项目无图片时显示引导提示
    - 提供开始创作的快捷入口
    - _需求: 1.3_

- [x] 14. 最终检查点 - 确保所有测试通过
  - 确保所有测试通过，如有问题请询问用户。

