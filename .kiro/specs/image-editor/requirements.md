# 图片编辑器功能需求

## 概述

为画布中的图片提供编辑和标注功能，用户可以在图片上绘制标记、添加形状、裁剪和旋转图片。编辑后的图片可以保存为新图片，支持所有现有图片操作（保存、删除、查看、作为参考图等）。

## 用户故事

### US-1: 打开图片编辑器
作为用户，我希望能够从画布图片或图片库中打开编辑器，以便对图片进行标注和编辑。

**验收标准：**
- AC-1.1: 画布图片右键菜单显示"编辑"选项
- AC-1.2: 图片详情面板显示"编辑"按钮
- AC-1.3: 点击后打开全屏编辑器界面
- AC-1.4: 编辑器加载原图（非缩略图）

### US-2: 画笔工具
作为用户，我希望能够使用画笔在图片上自由绘制，以便标记重点区域或添加手绘注释。

**验收标准：**
- AC-2.1: 提供画笔工具，支持自由绘制
- AC-2.2: 可调整画笔颜色（颜色选择器）
- AC-2.3: 可调整画笔粗细（至少3档：细、中、粗）
- AC-2.4: 绘制过程流畅，无明显延迟

### US-3: 形状工具
作为用户，我希望能够在图片上添加矩形和圆形，以便框选或标记特定区域。

**验收标准：**
- AC-3.1: 提供矩形绘制工具
- AC-3.2: 提供圆形/椭圆绘制工具
- AC-3.3: 形状支持设置边框颜色
- AC-3.4: 形状支持设置边框粗细
- AC-3.5: 形状默认无填充（只有边框）

### US-4: 裁剪功能
作为用户，我希望能够裁剪图片，以便去除不需要的部分。

**验收标准：**
- AC-4.1: 提供裁剪工具
- AC-4.2: 可拖拽调整裁剪区域
- AC-4.3: 显示裁剪预览
- AC-4.4: 确认后应用裁剪

### US-5: 旋转功能
作为用户，我希望能够旋转图片，以便调整图片方向。

**验收标准：**
- AC-5.1: 支持90度顺时针旋转
- AC-5.2: 支持90度逆时针旋转
- AC-5.3: 旋转后立即预览效果

### US-6: 撤销/重做
作为用户，我希望能够撤销和重做操作，以便修正错误。

**验收标准：**
- AC-6.1: 提供撤销按钮，可撤销上一步操作
- AC-6.2: 提供重做按钮，可恢复撤销的操作
- AC-6.3: 支持键盘快捷键（Ctrl/Cmd+Z 撤销，Ctrl/Cmd+Shift+Z 重做）
- AC-6.4: 撤销历史至少保留20步

### US-7: 保存编辑结果
作为用户，我希望能够保存编辑后的图片，以便后续使用。

**验收标准：**
- AC-7.1: 提供"保存为新图片"功能
- AC-7.2: 保存后的图片出现在原图旁边（画布位置）
- AC-7.3: 保存后的图片支持所有现有操作（删除、收藏、下载、作为参考图等）
- AC-7.4: 保存时显示加载状态
- AC-7.5: 保存成功后提示用户

### US-8: 作为参考图
作为用户，我希望能够将编辑后的图片直接设为参考图，以便用于图片生成。

**验收标准：**
- AC-8.1: 编辑器提供"保存并设为参考图"按钮
- AC-8.2: 点击后保存图片并自动设置为当前参考图
- AC-8.3: 关闭编辑器后参考图区域显示该图片

### US-9: 橡皮擦
作为用户，我希望能够擦除绘制的内容。

**验收标准：**
- AC-9.1: 提供橡皮擦工具
- AC-9.2: 可调整橡皮擦大小
- AC-9.3: 只擦除绘制内容，不影响原图

## 技术约束

1. 使用 Canvas 库实现（推荐 Fabric.js 或 Konva.js）
2. 编辑器需要支持触摸设备（可选）
3. 保存图片使用现有的 storageManager 接口
4. 支持本地模式和云端模式
5. 编辑大图时需要考虑性能优化

## UI/UX 要求

1. 编辑器全屏显示，有明显的关闭按钮
2. 工具栏位于顶部或左侧，图标清晰易懂
3. 当前选中的工具有高亮状态
4. 颜色选择器提供常用颜色快捷选择
5. 操作按钮（保存、取消）位于明显位置
6. 加载和保存时显示进度提示

## 优先级

| 优先级 | 功能 |
|--------|------|
| P0（必须） | 画笔、矩形、圆形、橡皮擦、保存为新图片 |
| P1（重要） | 裁剪、旋转、撤销/重做、作为参考图 |
