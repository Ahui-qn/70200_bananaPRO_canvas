# 需求文档

## 简介

本功能旨在让画布上的图片按照实际像素尺寸展示，而不是使用预设的固定比例。当前系统根据用户选择的宽高比和尺寸设置（1K/2K/4K）预先计算图片尺寸，但实际生成的图片尺寸可能与预期不同。通过在后端保存图片时获取真实像素尺寸，并将其持久化到数据库，前端可以准确地按原尺寸展示图片。

## 术语表

- **图片尺寸服务（ImageDimensionService）**：负责从图片 URL 或 Buffer 获取实际像素尺寸的后端服务
- **实际尺寸（Actual Dimensions）**：图片的真实像素宽度和高度
- **预设尺寸（Preset Dimensions）**：根据用户选择的宽高比和尺寸设置计算出的预期尺寸
- **sharp**：Node.js 高性能图片处理库，用于读取图片元数据

## 需求

### 需求 1

**用户故事：** 作为用户，我希望生成的图片能够按照实际像素尺寸在画布上展示，以便准确查看图片的真实比例和细节。

#### 验收标准

1. WHEN 后端保存生成的图片时 THEN 图片尺寸服务 SHALL 从图片数据中提取实际的宽度和高度像素值
2. WHEN 图片尺寸提取成功时 THEN 数据库服务 SHALL 将宽度和高度值保存到 images 表的 width 和 height 字段
3. WHEN 前端从数据库加载图片时 THEN 画布组件 SHALL 使用数据库中存储的实际尺寸来渲染图片
4. WHEN 图片尺寸提取失败时 THEN 系统 SHALL 回退使用预设尺寸并记录警告日志

### 需求 2

**用户故事：** 作为用户，我希望已存在的历史图片也能按实际尺寸展示，以便保持画布显示的一致性。

#### 验收标准

1. WHEN 加载没有尺寸数据的历史图片时 THEN 前端 SHALL 使用预设尺寸作为默认值
2. WHERE 管理员需要更新历史数据时 THEN 系统 SHALL 提供批量更新图片尺寸的脚本

### 需求 3

**用户故事：** 作为用户，我希望画布上显示大量高分辨率图片时不会卡顿，以便流畅地浏览和操作。

#### 验收标准

1. WHEN 画布上显示图片时 THEN 画布组件 SHALL 根据当前缩放比例动态选择加载原图或缩略图
2. WHEN 缩放比例小于 0.5 时 THEN 画布组件 SHALL 优先加载缩略图以减少内存占用
3. WHEN 缩放比例大于等于 0.5 时 THEN 画布组件 SHALL 加载原图以保证清晰度
4. WHEN 图片不在视口内时 THEN 画布组件 SHALL 延迟加载该图片以节省资源

### 需求 4

**用户故事：** 作为开发者，我希望图片尺寸获取过程不影响图片保存的性能，以便保持良好的用户体验。

#### 验收标准

1. WHEN 从 URL 下载图片时 THEN 图片尺寸服务 SHALL 复用已下载的图片数据来获取尺寸，避免重复下载
2. WHEN 获取图片尺寸时 THEN 图片尺寸服务 SHALL 在 500 毫秒内完成尺寸提取操作
3. IF 尺寸提取超时 THEN 系统 SHALL 继续保存图片并使用预设尺寸

### 需求 5

**用户故事：** 作为用户，我希望系统自动生成缩略图，以便在缩小视图时快速加载。

#### 验收标准

1. WHEN 保存图片到 OSS 时 THEN 图片尺寸服务 SHALL 同时生成并上传缩略图
2. WHEN 生成缩略图时 THEN 图片尺寸服务 SHALL 将较长边缩放至 400 像素并保持原始宽高比
3. WHEN 缩略图生成成功时 THEN 数据库服务 SHALL 将缩略图 URL 保存到 images 表的 thumbnail_url 字段



### 需求 6

**用户故事：** 作为用户，我希望能够点击图片快速放大查看细节，以便仔细检查生成的图片质量。

#### 验收标准

1. WHEN 用户双击画布上的图片时 THEN 画布组件 SHALL 将该图片居中显示并缩放至占据视口 80% 的大小
2. WHEN 图片放大显示时 THEN 画布组件 SHALL 自动加载原图以保证清晰度
3. WHEN 用户再次双击或按 ESC 键时 THEN 画布组件 SHALL 恢复到之前的视口位置和缩放比例
4. WHEN 执行放大/恢复操作时 THEN 画布组件 SHALL 使用平滑动画过渡（300 毫秒）

