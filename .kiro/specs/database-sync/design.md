# 数据库同步功能设计文档

## 概述

数据库同步功能旨在为 Nano Banana AI 绘画应用提供云端数据备份和多设备同步能力。该功能将本地 IndexedDB 中存储的图片信息同步到阿里云 MySQL 数据库，实现数据的持久化存储和跨设备访问。

系统采用"本地优先"的设计策略，确保在网络不稳定或数据库不可用时，用户仍能正常使用应用的核心功能。同步操作在后台进行，不会阻塞用户界面的响应。

## 架构

### 整体架构

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   用户界面层     │    │   业务逻辑层     │    │   数据存储层     │
│                │    │                │    │                │
│ - 数据库配置弹窗 │    │ - 混合存储服务   │    │ - 本地 IndexedDB │
│ - 同步状态显示   │◄──►│ - 数据库存储服务 │◄──►│ - 阿里云 MySQL   │
│ - 批量操作界面   │    │ - 同步管理器     │    │ - 云函数接口     │
│ - 进度指示器     │    │ - 错误处理器     │    │                │
└─────────────────┘    └─────────────────┘    └─────────────────┘
```

### 数据流向

1. **写入流程**: 用户操作 → 本地存储 → 后台同步到云端
2. **读取流程**: 本地存储优先 → 云端数据补充 → 合并显示
3. **同步流程**: 定时检查 → 增量同步 → 状态更新

## 组件和接口

### 核心组件

#### 1. DatabaseConfigModal 组件
- **职责**: 提供数据库配置界面
- **主要功能**:
  - 数据库连接参数配置
  - 连接测试和验证
  - 配置信息的保存和管理
  - 数据库表结构初始化

#### 2. HybridStorageService 服务
- **职责**: 管理本地和云端数据的混合存储
- **主要功能**:
  - 本地优先的数据访问策略
  - 自动后台同步机制
  - 同步状态管理
  - 冲突解决和数据合并

#### 3. DatabaseStorageService 服务
- **职责**: 处理云端数据库操作
- **主要功能**:
  - 数据库连接管理
  - CRUD 操作封装
  - 批量数据处理
  - 错误处理和重试机制

#### 4. SyncManager 同步管理器
- **职责**: 协调数据同步流程
- **主要功能**:
  - 同步任务调度
  - 进度跟踪和报告
  - 失败重试机制
  - 同步策略优化

### 接口定义

#### DatabaseConfig 接口
```typescript
interface DatabaseConfig {
  host: string;           // 数据库主机地址
  port: number;           // 端口号
  database: string;       // 数据库名称
  username: string;       // 用户名
  password: string;       // 密码
  ssl?: boolean;          // SSL 连接
  enabled: boolean;       // 是否启用
}
```

#### SyncResult 接口
```typescript
interface SyncResult {
  success: boolean;       // 同步是否成功
  totalCount: number;     // 总数据量
  syncedCount: number;    // 已同步数量
  failedCount: number;    // 失败数量
  errors?: string[];      // 错误信息列表
  duration: number;       // 同步耗时
}
```

#### SyncStatus 接口
```typescript
interface SyncStatus {
  isOnline: boolean;      // 数据库连接状态
  lastSync: Date | null;  // 最后同步时间
  pendingUploads: number; // 待上传数量
  pendingDownloads: number; // 待下载数量
  autoSyncEnabled: boolean; // 自动同步开关
}
```

## 数据模型

### 图片数据模型

云端数据库中的图片表结构与本地 IndexedDB 保持一致，主要字段包括：

```sql
CREATE TABLE images (
  id VARCHAR(50) PRIMARY KEY,      -- 图片唯一标识
  url TEXT NOT NULL,               -- 图片访问地址
  original_url TEXT,               -- 原始临时地址
  prompt TEXT NOT NULL,            -- 生成提示词
  model VARCHAR(100) NOT NULL,     -- AI 模型名称
  aspect_ratio VARCHAR(20),        -- 图像比例
  image_size VARCHAR(10),          -- 图像尺寸
  ref_images JSON,                 -- 参考图片信息
  created_at TIMESTAMP,            -- 创建时间
  tags JSON,                       -- 标签列表
  favorite BOOLEAN DEFAULT FALSE,  -- 收藏状态
  oss_key TEXT,                    -- OSS 对象键
  oss_uploaded BOOLEAN DEFAULT FALSE, -- OSS 上传状态
  user_id VARCHAR(50) DEFAULT 'default', -- 用户标识
  updated_at TIMESTAMP             -- 更新时间
);
```

### 同步日志模型

用于记录同步操作的历史和状态：

```sql
CREATE TABLE sync_logs (
  id BIGINT AUTO_INCREMENT PRIMARY KEY,
  operation VARCHAR(50) NOT NULL,  -- 操作类型
  table_name VARCHAR(50) NOT NULL, -- 表名
  record_id VARCHAR(50),           -- 记录ID
  user_id VARCHAR(50),             -- 用户ID
  status ENUM('SUCCESS', 'FAILED'), -- 状态
  error_message TEXT,              -- 错误信息
  created_at TIMESTAMP             -- 创建时间
);
```

## 正确性属性

*属性是一个特征或行为，应该在系统的所有有效执行中保持为真——本质上是关于系统应该做什么的正式声明。属性作为人类可读规范和机器可验证正确性保证之间的桥梁。*

基于前期分析，以下是系统需要满足的正确性属性：

### 属性 1: 配置验证完整性
*对于任何* 数据库配置输入，当所有必需字段（host、database、username、password）都不为空时，配置验证应该返回有效状态
**验证需求: 1.2**

### 属性 2: 连接测试一致性
*对于任何* 有效的数据库配置，连接测试的结果应该与实际数据库可访问性保持一致
**验证需求: 1.3**

### 属性 3: 配置持久化往返一致性
*对于任何* 保存的数据库配置，从本地存储读取后应该与原始配置完全相同
**验证需求: 1.5**

### 属性 4: 批量上传数据完整性
*对于任何* 选中的图片集合，批量上传操作应该确保所有图片信息都被正确传输到云端数据库
**验证需求: 3.3**

### 属性 5: 上传进度准确性
*对于任何* 批量上传操作，显示的进度应该准确反映已处理的图片数量与总数量的比例
**验证需求: 3.4**

### 属性 6: 同步时间戳更新
*对于任何* 成功的数据同步操作，最后同步时间应该被更新为操作完成的时间
**验证需求: 4.4**

### 属性 7: 待上传数据统计准确性
*对于任何* 时刻，显示的待上传数据数量应该等于本地存在但云端不存在的图片数量
**验证需求: 4.5**

### 属性 8: 自动同步触发机制
*对于任何* 新保存到本地的图片，当数据库连接可用时，系统应该自动尝试将其同步到云端
**验证需求: 5.1**

### 属性 9: 网络恢复后补偿同步
*对于任何* 之前因网络问题失败的同步操作，当网络恢复后应该能够重新同步这些数据
**验证需求: 5.5**

### 属性 10: 云端数据下载完整性
*对于任何* 从云端同步的操作，所有云端存在的图片信息都应该被正确下载到本地
**验证需求: 6.2**

### 属性 11: 数据去重逻辑
*对于任何* 已存在于本地的图片，从云端同步时应该跳过重复数据，避免产生冲突
**验证需求: 6.4**

### 属性 12: 配置变更检测
*对于任何* 数据库配置的修改，系统应该能够检测到变更并相应地启用或禁用保存按钮
**验证需求: 8.1**

### 属性 13: 配置清除完整性
*对于任何* 配置清除操作，所有相关的本地存储数据都应该被完全删除
**验证需求: 8.4**

## 错误处理

### 错误分类

1. **连接错误**
   - 网络超时
   - 主机不可达
   - 端口拒绝连接

2. **认证错误**
   - 用户名或密码错误
   - 权限不足
   - SSL 证书问题

3. **数据错误**
   - 数据格式不正确
   - 约束违反
   - 数据过大

4. **系统错误**
   - 内存不足
   - 磁盘空间不足
   - 未知异常

### 错误处理策略

1. **重试机制**: 对于临时性错误（如网络超时），实施指数退避重试
2. **降级处理**: 当云端不可用时，确保本地功能正常运行
3. **用户反馈**: 提供清晰的错误信息和解决建议
4. **日志记录**: 记录详细的错误信息用于调试和监控

### 错误恢复

1. **自动恢复**: 网络恢复后自动重新连接和同步
2. **手动恢复**: 提供手动重试和重新配置选项
3. **数据修复**: 检测和修复数据不一致问题

## 测试策略

### 双重测试方法

系统将采用单元测试和基于属性的测试相结合的方法：

- **单元测试**: 验证特定示例、边界情况和错误条件
- **基于属性的测试**: 验证在所有输入中都应该成立的通用属性

两种测试方法相互补充：单元测试捕获具体错误，基于属性的测试验证通用正确性。

### 单元测试覆盖

单元测试将覆盖：
- 数据库配置验证的具体示例
- 连接成功和失败的场景
- UI 状态变化的特定情况
- 错误处理的边界情况

### 基于属性的测试

将使用 **fast-check** 作为 JavaScript/TypeScript 的基于属性的测试库。每个基于属性的测试将：
- 配置为运行最少 100 次迭代
- 使用注释明确标识对应的设计文档属性
- 采用格式：`**Feature: database-sync, Property {number}: {property_text}**`

### 测试数据生成

为基于属性的测试创建智能生成器：
- **数据库配置生成器**: 生成有效和无效的配置组合
- **图片数据生成器**: 生成各种图片信息用于同步测试
- **网络状态模拟器**: 模拟不同的网络连接状态

### 测试执行策略

1. **开发阶段**: 每次代码变更后运行所有测试
2. **集成阶段**: 运行完整的测试套件包括长时间运行的属性测试
3. **部署前**: 执行端到端测试验证整个同步流程